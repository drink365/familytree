# app.py
# -*- coding: utf-8 -*-

import json
import uuid
from typing import Dict, List, Tuple

import streamlit as st
from graphviz import Digraph
from collections import defaultdict

st.set_page_config(page_title="Family Tree", page_icon="üå≥", layout="wide")


# -----------------------------
# Data model (kept in session)
# -----------------------------
# data = {
#   "persons": { pid: {"id": pid, "name": str, "sex": "Áî∑"/"Â•≥", "alive": bool, "note": str} },
#   "marriages": { mid: {"id": mid, "a": pidA, "b": pidB, "divorced": bool} },
#   "children": [ {"mid": mid, "child": pid}, ... ],
#   "sibling_links": [ (pid1, pid2), ... ],
#   "_seq": int
# }

def _empty_data():
    return {
        "persons": {},
        "marriages": {},
        "children": [],
        "sibling_links": [],
        "_seq": 0,
    }

def ensure_session():
    if "data" not in st.session_state:
        st.session_state.data = _empty_data()

def next_id():
    st.session_state.data["_seq"] += 1
    return str(st.session_state.data["_seq"])


# -----------------------------
# Demo Data Helpers
# -----------------------------
def ensure_person(name, sex="Áî∑", alive=True, note=""):
    """Find or create person by name; return pid."""
    d = st.session_state.data
    for pid, p in d["persons"].items():
        if p["name"] == name:
            return pid
    pid = next_id()
    d["persons"][pid] = {"id": pid, "name": name, "sex": sex, "alive": alive, "note": note}
    return pid

def add_marriage(a, b, divorced=False):
    """Return mid. If same pair exists, update divorced flag and return existing mid."""
    d = st.session_state.data
    for mid, m in d["marriages"].items():
        if {m["a"], m["b"]} == {a, b}:
            m["divorced"] = bool(divorced)
            return mid
    mid = f"M{next_id()}"
    d["marriages"][mid] = {"id": mid, "a": a, "b": b, "divorced": bool(divorced)}
    return mid

def add_child(mid, child):
    d = st.session_state.data
    if mid not in d["marriages"]:
        return
    if not any((x["mid"] == mid and x["child"] == child) for x in d["children"]):
        d["children"].append({"mid": mid, "child": child})

def add_sibling_link(a, b):
    if a == b:
        return
    a, b = sorted([a, b])
    d = st.session_state.data
    if (a, b) not in d["sibling_links"]:
        d["sibling_links"].append((a, b))

def load_demo(clear=True):
    if clear:
        st.session_state.data = _empty_data()
    ensure_session()
    d = st.session_state.data

    # ‰∫∫Áâ©
    yilang = ensure_person("Èô≥‰∏ÄÈÉé", "Áî∑", True)
    exwife = ensure_person("Èô≥ÂâçÂ¶ª", "Â•≥", True)
    wife   = ensure_person("Èô≥Â¶ª",   "Â•≥", True)
    wangzi = ensure_person("ÁéãÂ≠ê",   "Áî∑", True)
    wz_wife= ensure_person("ÁéãÂ≠êÂ¶ª", "Â•≥", True)
    chenda = ensure_person("Èô≥Â§ß",   "Áî∑", True)
    chener = ensure_person("Èô≥‰∫å",   "Áî∑", True)
    chensan= ensure_person("Èô≥‰∏â",   "Áî∑", True)
    w_sun  = ensure_person("ÁéãÂ≠´",   "Áî∑", True)
    erA    = ensure_person("‰∫åÂ≠©A",  "Â•≥", True)
    erB    = ensure_person("‰∫åÂ≠©B",  "Áî∑", True)
    erC    = ensure_person("‰∫åÂ≠©C",  "Â•≥", True)
    sanA   = ensure_person("‰∏âÂ≠©A",  "Áî∑", True)
    sanB   = ensure_person("‰∏âÂ≠©B",  "Â•≥", True)
    chenda_sp = ensure_person("Èô≥Â§ßÂ´Ç", "Â•≥", True)
    chener_sp = ensure_person("Èô≥‰∫åÂ´Ç", "Â•≥", True)
    chensan_sp= ensure_person("Èô≥‰∏âÂ´Ç", "Â•≥", True)

    # Â©öÂßª
    m1 = add_marriage(yilang, exwife, divorced=True)
    m2 = add_marriage(yilang, wife, divorced=False)
    m3 = add_marriage(wangzi, wz_wife, divorced=False)
    m4 = add_marriage(chenda, chenda_sp, False)
    m5 = add_marriage(chener, chener_sp, False)
    m6 = add_marriage(chensan, chensan_sp, False)

    # Â≠êÂ•≥
    add_child(m1, wangzi)
    add_child(m2, chenda)
    add_child(m2, chener)
    add_child(m2, chensan)
    add_child(m3, w_sun)
    add_child(m5, erA)
    add_child(m5, erB)
    add_child(m5, erC)
    add_child(m6, sanA)
    add_child(m6, sanB)


# -----------------------------
# Kinship helpers (for tools)
# -----------------------------
def build_child_map():
    """Return (children_by_parent, parents_of_child)."""
    d = st.session_state.data
    children_by_parent = defaultdict(list)
    parents_of_child = defaultdict(list)
    pairs = {mid: (m["a"], m["b"]) for mid, m in d["marriages"].items()}
    for row in d["children"]:
        mid, c = row["mid"], row["child"]
        if mid not in pairs:
            continue
        a, b = pairs[mid]
        if a:
            children_by_parent[a].append(c)
            parents_of_child[c].append(a)
        if b:
            children_by_parent[b].append(c)
            parents_of_child[c].append(b)
    return children_by_parent, parents_of_child

def lineal_heirs_with_representation(decedent):
    d = st.session_state.data
    children_by_parent, _ = build_child_map()

    def collect_lineal(children_list):
        line = []
        for c in children_list:
            person = d["persons"].get(c)
            if not person:
                continue
            if person["alive"]:
                line.append(c)
            else:
                cc = children_by_parent.get(c, [])
                line.extend(collect_lineal(cc))
        return line

    children = children_by_parent.get(decedent, [])
    heirs = collect_lineal(children)
    return list(dict.fromkeys(heirs))

def parents_of(pid):
    _, parent_map = build_child_map()
    return list(parent_map.get(pid, []))

def siblings_of(pid):
    d = st.session_state.data
    _, parent_map = build_child_map()
    sibs = set()
    my_parents = set(parent_map.get(pid, []))
    for cid, parents in parent_map.items():
        if cid == pid:
            continue
        if set(parents) == my_parents and parents:
            sibs.add(cid)
    for a, b in d["sibling_links"]:
        if a == pid:
            sibs.add(b)
        if b == pid:
            sibs.add(a)
    return list(sibs)

def grandparents_of(pid):
    gps = set()
    for p in parents_of(pid):
        gps.update(parents_of(p))
    return list(gps)

def find_spouses(pid):
    d = st.session_state.data
    res = []
    for mid, m in d["marriages"].items():
        if m["a"] == pid:
            res.append((mid, m["b"], m["divorced"]))
        elif m["b"] == pid:
            res.append((mid, m["a"], m["divorced"]))
    return res

def heirs_1138(decedent):
    """Ê∞ëÊ≥ï1138È†Ü‰ΩçÔºàÁ∞°ÂåñÁ§∫ÊÑèÔºâÔºöÈÖçÂÅ∂ + Áõ¥Á≥ªÂçëË¶™Â±¨ / Áà∂ÊØç / ÂÖÑÂºüÂßäÂ¶π / Á•ñÁà∂ÊØç"""
    d = st.session_state.data
    out = {"spouse": [], "rank": 0, "heirs": []}
    spouses = [sp for _, sp, _ in find_spouses(decedent)]
    out["spouse"] = spouses

    rank1 = [x for x in lineal_heirs_with_representation(decedent) if d["persons"][x]["alive"]]
    if rank1:
        out["rank"] = 1; out["heirs"] = rank1; return out

    rank2 = [p for p in parents_of(decedent) if d["persons"][p]["alive"]]
    if rank2:
        out["rank"] = 2; out["heirs"] = rank2; return out

    rank3 = [s for s in siblings_of(decedent) if d["persons"][s]["alive"]]
    if rank3:
        out["rank"] = 3; out["heirs"] = rank3; return out

    rank4 = [g for g in grandparents_of(decedent) if d["persons"][g]["alive"]]
    if rank4:
        out["rank"] = 4; out["heirs"] = rank4; return out

    return out


# -----------------------------
# Graphviz Family Tree (marriage hub)
# -----------------------------
COLOR_MALE   = "#d8eaff"
COLOR_FEMALE = "#ffdbe1"
COLOR_DEAD   = "#e6e6e6"
BORDER_COLOR = "#164b5f"
FONT_COLOR   = "#0b2430"

def person_node(dot, pid, p):
    label = p["name"] + ("" if p["alive"] else "ÔºàÊÆÅÔºâ")
    shape = "box" if p["sex"] == "Áî∑" else "ellipse"
    fill = COLOR_DEAD if not p["alive"] else (COLOR_MALE if p["sex"] == "Áî∑" else COLOR_FEMALE)
    dot.node(pid, label, shape=shape, style="filled", fillcolor=fill,
             color=BORDER_COLOR, fontcolor=FONT_COLOR, penwidth="1.4")

def build_dot(data: Dict) -> str:
    persons = data["persons"]
    marriages = data["marriages"]
    children = data["children"]

    dot = Digraph("Family", format="svg", engine="dot")
    dot.graph_attr.update(rankdir="TB", splines="ortho", nodesep="0.5", ranksep="0.7", bgcolor="white")

    # Persons
    for pid, p in persons.items():
        person_node(dot, pid, p)

    # Spouse horizontal line (marriage), dashed if divorced
    for mid, m in marriages.items():
        a, b, divorced = m["a"], m["b"], m["divorced"]
        style = "dashed" if divorced else "solid"
        dot.edge(a, b, dir="none", color=BORDER_COLOR, penwidth="1.2", style=style)

    # Child from marriage hub
    for mid, m in marriages.items():
        hub = f"hub_{mid}"
        dot.node(hub, label="", shape="point", width="0.01", height="0.01", color=BORDER_COLOR)
        dot.edge(m["a"], hub, dir="none", color=BORDER_COLOR, penwidth="1.0")
        dot.edge(m["b"], hub, dir="none", color=BORDER_COLOR, penwidth="1.0")
        for row in children:
            if row["mid"] == mid:
                dot.edge(hub, row["child"], dir="none", color=BORDER_COLOR, penwidth="1.0")

    return dot.source


# -----------------------------
# UI Components
# -----------------------------
def list_person_options(include_empty=False):
    d = st.session_state.data
    opts = []
    if include_empty:
        opts.append(("", "ÔºàÊú™ÈÅ∏ÊìáÔºâ"))
    for pid, p in d["persons"].items():
        tag = "" if p["alive"] else "ÔºàÊÆÅÔºâ"
        opts.append((pid, f'{p["name"]}{tag} / {p["sex"]}'))
    return opts

def pick_from(label, options, key=None):
    show = [o[1] for o in options]
    idx = st.selectbox(label, range(len(show)), format_func=lambda i: show[i], key=key)
    return options[idx][0]


# -----------------------------
# Pages
# -----------------------------
def page_people():
    d = st.session_state.data
    st.subheader("üßë ‰∫∫Áâ©")
    with st.form("form_add_person"):
        c1, c2, c3 = st.columns([2,1,1])
        with c1:
            name = st.text_input("ÂßìÂêç")
        with c2:
            sex = st.selectbox("ÊÄßÂà•", ["Áî∑", "Â•≥"])
        with c3:
            alive = st.selectbox("ÁãÄÊÖã", ["Âú®‰∏ñ", "Â∑≤ÊïÖ"])
        ok = st.form_submit_button("Êñ∞Â¢û‰∫∫Áâ©")
        if ok:
            if not name.strip():
                st.warning("Ë´ãËº∏ÂÖ•ÂßìÂêç")
            else:
                pid = next_id()
                d["persons"][pid] = {"id": pid, "name": name.strip(), "sex": sex, "alive": (alive=="Âú®‰∏ñ"), "note": ""}
                st.success("Â∑≤Êñ∞Â¢û")
                st.rerun()

    st.divider()
    st.subheader("‚úèÔ∏è Á∑®ËºØ‰∫∫Áâ©")
    if not d["persons"]:
        st.info("ÁõÆÂâçÂ∞öÁÑ°‰∫∫Áâ©„ÄÇ")
        return
    p_pick = pick_from("ÈÅ∏Êìá‰∫∫Áâ©", list_person_options(), key="edit_person_pick")
    if p_pick:
        p = d["persons"][p_pick]
        with st.form("form_edit_person"):
            c1, c2, c3 = st.columns([2,1,1])
            with c1:
                name = st.text_input("ÂßìÂêç", p["name"])
            with c2:
                sex = st.selectbox("ÊÄßÂà•", ["Áî∑", "Â•≥"], index=0 if p["sex"]=="Áî∑" else 1)
            with c3:
                alive = st.checkbox("Âú®‰∏ñ", value=p["alive"])
            note = st.text_input("ÂÇôË®ª", p.get("note",""))
            c1b, c2b = st.columns(2)
            ok = c1b.form_submit_button("ÂÑ≤Â≠ò")
            del_ = c2b.form_submit_button("Âà™Èô§Ê≠§‰∫∫")
            if ok:
                p.update({"name": name.strip() or p["name"], "sex": sex, "alive": alive, "note": note})
                st.success("Â∑≤Êõ¥Êñ∞")
                st.rerun()
            if del_:
                mids_to_del = [mid for mid, m in d["marriages"].items() if p_pick in (m["a"], m["b"])]
                for mid in mids_to_del:
                    d["children"] = [row for row in d["children"] if row["mid"] != mid]
                    d["marriages"].pop(mid, None)
                d["children"] = [row for row in d["children"] if row["child"] != p_pick]
                d["sibling_links"] = [t for t in d["sibling_links"] if p_pick not in t]
                d["persons"].pop(p_pick, None)
                st.success("Â∑≤Âà™Èô§")
                st.rerun()

def page_relations():
    d = st.session_state.data
    st.subheader("üîó Èóú‰øÇ")

    st.markdown("### Âª∫Á´ãÂ©öÂßªÔºàÁèæ‰ªª / Èõ¢Â©öÔºâ")
    with st.form("form_marriage"):
        colA, colB, colC = st.columns([2,2,1])
        with colA:
            a = pick_from("ÈÖçÂÅ∂ A", list_person_options(include_empty=True), key="marry_a")
        with colB:
            b = pick_from("ÈÖçÂÅ∂ B", list_person_options(include_empty=True), key="marry_b")
        with colC:
            divorced = st.checkbox("Ê≠§Â©öÂßªÁÇ∫Èõ¢Â©ö/ÂâçÈÖçÂÅ∂", value=False)
        ok = st.form_submit_button("Âª∫Á´ãÂ©öÂßª")
        if ok:
            if not a or not b:
                st.warning("Ë´ãÈÅ∏ÊìáÈõôÊñπ„ÄÇ")
            elif a == b:
                st.warning("ÂÖ©ÂÄãÊ¨Ñ‰Ωç‰∏çÂèØÁÇ∫Âêå‰∏Ä‰∫∫„ÄÇ")
            else:
                add_marriage(a, b, divorced)
                st.success("Â©öÂßªÂ∑≤Âª∫Á´ã/Êõ¥Êñ∞")
                st.rerun()

    st.divider()
    st.markdown("### Êñ∞Â¢ûÂ≠êÂ•≥")
    if not d["marriages"]:
        st.info("Ë´ãÂÖàÂª∫Á´ãËá≥Â∞ë‰∏ÄÊÆµÂ©öÂßª„ÄÇ")
    else:
        with st.form("form_child"):
            mids = list(d["marriages"].keys())
            def _fmt_mid(m):
                a, b = d["marriages"][m]["a"], d["marriages"][m]["b"]
                na = d["persons"][a]["name"]
                nb = d["persons"][b]["name"]
                tag = "ÔºàÈõ¢Ôºâ" if d["marriages"][m]["divorced"] else ""
                return f"{na} ‚Üî {nb}{tag}"
            mid_idx = st.selectbox("ÈÅ∏ÊìáÂ©öÂßª", range(len(mids)), format_func=lambda i: _fmt_mid(mids[i]))
            mid = mids[mid_idx] if mids else ""
            child = pick_from("ÈÅ∏ÊìáÂ≠êÂ•≥‰∫∫Áâ©ÔºàË´ãÂÖàÂà∞„Äå‰∫∫Áâ©„ÄçÈ†ÅÊñ∞Â¢ûÔºâ", list_person_options(), key="pick_child_for_mid")
            ok = st.form_submit_button("Âä†ÂÖ•Â≠êÂ•≥")
            if ok:
                if not mid or not child:
                    st.warning("Ë´ãÈÅ∏ÊìáÂ©öÂßªËàáÂ≠êÂ•≥„ÄÇ")
                else:
                    add_child(mid, child)
                    st.success("Â∑≤Âä†ÂÖ•Â≠êÂ•≥")
                    st.rerun()

def page_tree():
    d = st.session_state.data
    st.subheader("üå≥ ÂÆ∂ÊóèÊ®π")
    if not d["persons"]:
        st.info("Ë´ãÂÖàÊñ∞Â¢û‰∫∫Áâ©ËàáÈóú‰øÇÔºåÊàñÈªûÂè≥‰∏äËßí„ÄåËºâÂÖ•Á§∫ÁØÑ„Äç„ÄÇ")
        return
    dot_src = build_dot(d)
    st.graphviz_chart(dot_src, use_container_width=True)

def page_tools():
    d = st.session_state.data
    st.subheader("‚öñÔ∏è Ê≥ïË¶èÂ∞èÂ∑•ÂÖ∑ÔºàÁ§∫ÊÑèÔºâ")
    if not d["persons"]:
        st.info("Ë´ãÂÖàÊñ∞Â¢û‰∫∫Áâ©ÊàñËºâÂÖ•Á§∫ÁØÑ„ÄÇ")
        return
    decedent = pick_from("ÈÅ∏ÊìáË¢´ÁπºÊâø‰∫∫", list_person_options(), key="heir_dec")
    if st.button("Ë®àÁÆóÊ≥ïÂÆöÁπºÊâøÈ†Ü‰Ωç"):
        res = heirs_1138(decedent)
        rank_map = {0:"ÁÑ°",1:"Áõ¥Á≥ªÂçëË¶™Â±¨",2:"Áà∂ÊØç",3:"ÂÖÑÂºüÂßäÂ¶π",4:"Á•ñÁà∂ÊØç"}
        st.write("ÈÖçÂÅ∂Ôºö", "„ÄÅ".join(d["persons"][x]["name"] for x in res["spouse"]) or "ÔºàÁÑ°Ôºâ")
        st.write("È†Ü‰ΩçÔºö", rank_map.get(res["rank"], ""))
        st.write("ÂêåÈ†Ü‰ΩçÁπºÊâø‰∫∫Ôºö", "„ÄÅ".join(d["persons"][x]["name"] for x in res["heirs"]) or "ÔºàÁÑ°Ôºâ")


# -----------------------------
# Main
# -----------------------------
def main():
    ensure_session()

    top_left, top_right = st.columns([1,1])
    with top_left:
        st.markdown("### üå≥ Family TreeÔºàGraphviz ÁâàÔºâ")
        st.caption("‰∏ç‰æùË≥¥Â§ñÈÉ® JSÔºõÂ§´Â¶ªÁî±Â©öÂßªÁ∑öÊ∞¥Âπ≥Áõ∏ÈÄ£ÔºåÂ≠êÂ•≥Áî±Â©öÂßªÈªûÂêë‰∏ãÁõ∏ÈÄ£„ÄÇ")
    with top_right:
        c1, c2 = st.columns(2)
        if c1.button("ËºâÂÖ•Á§∫ÁØÑ", use_container_width=True):
            load_demo(clear=True)
            st.success("Â∑≤ËºâÂÖ•Á§∫ÁØÑ")
            st.rerun()
        if c2.button("Ê∏ÖÁ©∫Ë≥áÊñô", use_container_width=True):
            st.session_state.data = _empty_data()
            st.success("Â∑≤Ê∏ÖÁ©∫")
            st.rerun()

    st.divider()

    tab1, tab2, tab3, tab4 = st.tabs(["‰∫∫Áâ©", "Èóú‰øÇ", "ÂÆ∂ÊóèÊ®π", "Â∑•ÂÖ∑"])
    with tab1:
        page_people()
    with tab2:
        page_relations()
    with tab3:
        page_tree()
    with tab4:
        page_tools()

    st.markdown(
        """
        <div style="color:#64748b;font-size:12px;margin-top:8px">
          ÊèêÁ§∫ÔºöËã•Ë¶Å‰∏ãËºâÂúñÊ™îÔºåÂèØÁî®ÁÄèË¶ΩÂô®ÂàóÂç∞Êàê PDF ÊàñÊì∑Âèñ SVGÔºàÈúÄÂè¶Ë°åÊì¥ÂÖÖÔºâ„ÄÇ
        </div>
        """,
        unsafe_allow_html=True,
    )

if __name__ == "__main__":
    main()
